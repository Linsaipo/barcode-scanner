<!DOCTYPE html>
<html>
<head>
    <title>æ¢ç¢¼æƒææ¸¬è©¦</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        #reader {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        .loading {
            background-color: #f0f0f0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js">function switchCamera() {
    const selected = document.getElementById("cameraSelect").value;
    if (selected && selected !== selectedCameraId) {
        selectedCameraId = selected;
        localStorage.setItem("preferredCameraId", selected);
        stopScanner();
        setTimeout(startScanner, 300);
    }
}
</script>
</head>
<body>
    <label for="cameraSelect"><strong>ğŸ¥ é¸æ“‡é¡é ­ï¼š</strong></label><br>
<select id="cameraSelect" onchange="switchCamera()" style="padding: 6px; max-width: 300px; width: 90%; margin: 10px 0;"></select>
<div id="reader"></div>
    <div id="success" style="color:green; font-weight: bold;"></div>
    <div id="error" style="color:red; font-weight: bold;"></div>

    <label for="staff">å“¡å·¥ï¼š</label>
    <select id="staff"></select><br><br>
    <label for="item">è²¡ç”¢ç·¨è™Ÿï¼š</label>
    <input type="text" id="item" readonly><br><br>
    <label for="itemName">å“é …åï¼š</label>
    <input type="text" id="itemName" readonly><br><br>
    <label for="description">æè¿°ï¼š</label>
    <input type="text" id="description" readonly><br><br>
    <label for="location">ç›®å‰ä½ç½®ï¼š</label>
    <input type="text" id="location"><br><br>
    <label for="to">ç§»è‡³ï¼š</label>
    <input type="text" id="to"><br><br>
    <label for="note">å‚™è¨»ï¼š</label>
    <input type="text" id="note"><br><br>

    <button id="startButton" onclick="startScanner()">é–‹å§‹æƒæ</button>
    <button id="stopButton" onclick="stopScanner()" style="display:none;">åœæ­¢æƒæ</button>
    <button onclick="submitForm()">é€å‡º</button>

    <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec";
    let html5QrCode;
    let selectedCameraId;
let availableCameras = [];

    async function loadStaffList() {
        try {
            const response = await fetch(`${API_BASE}?action=getStaffList`);
            const data = await response.json();
            if (Array.isArray(data)) {
                const staffSelect = document.getElementById("staff");
                staffSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>' +
                  data.map(name => `<option value="${name}">${name}</option>`).join("");
            } else {
                document.getElementById("error").textContent = "âŒ å“¡å·¥æ¸…å–®è¼‰å…¥éŒ¯èª¤";
                console.error("getStaffList response:", data);
            }
        } catch (err) {
            document.getElementById("error").textContent = "âŒ ç„¡æ³•å–å¾—å“¡å·¥æ¸…å–®";
            console.error(err);
        }
    }

    async function getItemData(itemCode) {
        const res = await fetch(`${API_BASE}?action=getLocation&itemCode=${encodeURIComponent(itemCode)}`);
        const data = await res.json();
        return data;
    }

    async function startScanner() {
    const readerEl = document.getElementById("reader");
    readerEl.classList.add("loading");

    try {
        if (!selectedCameraId) {
            throw new Error("å°šæœªé¸æ“‡ç›¸æ©Ÿ");
        }

        if (html5QrCode?.getState && html5QrCode.getState() === 2) { // å·²å•Ÿå‹•
            await html5QrCode.stop();
            document.getElementById("reader").innerHTML = "";
        }

        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start(
            { deviceId: { exact: selectedCameraId } },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            async decodedText => {
                document.getElementById("item").value = decodedText;
                const data = await getItemData(decodedText);
                document.getElementById("itemName").value = data.item || "";
                document.getElementById("description").value = data.desc || "";
                document.getElementById("location").value = data.location || "";
                document.getElementById("success").textContent = "âœ… æƒææˆåŠŸ";
                stopScanner();
            },
            errorMessage => {
                console.log("æƒæéŒ¯èª¤:", errorMessage);
            }
        );
        document.getElementById("stopButton").style.display = "inline-block";
    } catch (err) {
        document.getElementById("error").textContent = `âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š${err.message}`;
        console.error("startScanner error:", err);
    } finally {
        readerEl.classList.remove("loading");
    }
} },
                async decodedText => {
                    document.getElementById("item").value = decodedText;
                    const data = await getItemData(decodedText);
                    document.getElementById("itemName").value = data.item || "";
                    document.getElementById("description").value = data.desc || "";
                    document.getElementById("location").value = data.location || "";
                    document.getElementById("success").textContent = "âœ… æƒææˆåŠŸ";
                    stopScanner();
                }
            );
            document.getElementById("stopButton").style.display = "inline-block";
        } catch (err) {
            document.getElementById("error").textContent = `âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š${err.message}`;
            console.error("startScanner error:", err);
        } finally {
            readerEl.classList.remove("loading");
        }
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById("reader").innerHTML = "";
                document.getElementById("stopButton").style.display = "none";
            });
        }
    }

    function submitForm() {
        const staff = document.getElementById("staff").value.trim();
        const item = document.getElementById("item").value.trim();
        const location = document.getElementById("location").value.trim();
        const to = document.getElementById("to").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!staff || !item) {
            document.getElementById("error").textContent = "âŒ è«‹é¸æ“‡å“¡å·¥ä¸¦æƒæè²¡ç”¢ç·¨è™Ÿ";
            return;
        }

        fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                action: "submitForm",
                staff, item, location, to, note
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.result === "success") {
                document.getElementById("success").textContent = "âœ… è³‡æ–™å¯«å…¥æˆåŠŸ";
                document.getElementById("error").textContent = "";
            } else {
                document.getElementById("error").textContent = "âŒ å¯«å…¥å¤±æ•—";
            }
        })
        .catch(err => {
            document.getElementById("error").textContent = "âŒ ç™¼é€å¤±æ•—";
            console.error("submitForm error:", err);
        });
    }

    window.onload = () => {
        if (window.isSecureContext) {
            loadStaffList();
            Html5Qrcode.getCameras().then(devices => {
                availableCameras = devices;
                const cameraSelect = document.getElementById("cameraSelect");
                cameraSelect.innerHTML = devices.map((d, i) => `<option value="${d.id}">${d.label || `é¡é ­ ${i+1}`}</option>`).join("");

                const savedCameraId = localStorage.getItem("preferredCameraId");
                const defaultCamera = devices.find(d => d.id === savedCameraId) ||
                                     devices.find(d => d.label.toLowerCase().includes("environment")) ||
                                     devices.find(d => d.label.toLowerCase().includes("back")) ||
                                     devices[0];
                selectedCameraId = defaultCamera?.id;
                cameraSelect.value = selectedCameraId;
                startScanner();
            }).catch(err => {
                document.getElementById("error").textContent = "âŒ ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¸…å–®";
                console.error("getCameras error:", err);
            });
        } else {
            document.getElementById("error").textContent = "âŒ è«‹ä½¿ç”¨ HTTPS é–‹å•Ÿæœ¬é ";
        }
    };
        } else {
            document.getElementById("error").textContent = "âŒ è«‹ä½¿ç”¨ HTTPS é–‹å•Ÿæœ¬é ";
        }
    };
    </script>
</body>
</html>
