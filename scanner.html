<!DOCTYPE html>
<html>
<head>
    <title>條碼掃描測試</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        #reader {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        .loading {
            background-color: #f0f0f0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="reader"></div>
    <div id="success" style="color:green; font-weight: bold;"></div>
    <div id="error" style="color:red; font-weight: bold;"></div>
    <label for="staff">員工：</label>
    <select id="staff" name="staff"></select>
<input type="text" id="item" name="item" readonly>
<input type="text" id="location" name="location">
<input type="text" id="to" name="to">
<input type="text" id="note" name="note">
    <label for="note">備註：</label>
    <input type="text" id="note"><br><br>

    <button id="startButton" onclick="startScanner()">開始掃描</button>
    <button id="stopButton" onclick="stopScanner()" style="display:none;">停止掃描</button>
    <button id="retryButton" onclick="startScanner()" style="display:none;">重試</button>
    <button onclick="submitForm()">送出</button>

    <script>
        let html5QrCode;
        const resultEl = document.getElementById("success");
        const errorEl = document.getElementById("error");
        const stopButton = document.getElementById("stopButton");
        const retryButton = document.getElementById("retryButton");
        const staffSelect = document.getElementById("staff");
        let selectedCameraId;
        let isSecureContext = window.isSecureContext;

        console.log("頁面載入時 - isSecureContext:", isSecureContext);

        if (!isSecureContext) {
            errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面以啟用攝影機";
            document.querySelectorAll("button").forEach(btn => btn.disabled = true);
        }

        async function loadStaffList() {
            console.log("loadStaffList() 被呼叫");
            try {
                // 將此處的 URL 替換為你的 Google Apps Script Web 應用程式 URL
                const scriptUrl = "https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec?action=getStaffList";
                const response = await fetch(scriptUrl);
                const staffList = await response.json();

                if (!staffList || !Array.isArray(staffList) || staffList.length === 0) {
                    errorEl.textContent = "❌ 無法取得員工清單或清單為空";
                    console.error("loadStaffList() 錯誤: 無效的員工清單", staffList);
                    staffSelect.disabled = true;
                    return;
                }

                staffSelect.innerHTML = '<option value="">請選擇</option>' +
                    staffList.map(name => `<option value="${name}">${name}</option>`).join("");
                console.log("loadStaffList() 成功載入員工清單:", staffList);
            } catch (err) {
                errorEl.textContent = `❌ 無法載入員工清單：${err.message}`;
                console.error("loadStaffList() 錯誤:", err);
                staffSelect.disabled = true;
            }
        }

        async function selectBackCamera() {
            if (!isSecureContext) return;
            console.log("selectBackCamera() 被呼叫");
            try {
                const cameras = await Html5Qrcode.getCameras();
                console.log("可用相機:", cameras);
                if (cameras && cameras.length) {
                    selectedCameraId = cameras[cameras.length - 1].id; // 選擇最後一個相機
                    console.log("選擇的相機 ID:", selectedCameraId);
                } else {
                    errorEl.textContent = "❌ 找不到攝影機";
                    console.error("找不到攝影機");
                }
            } catch (err) {
                errorEl.textContent = `❌ 無法取得攝影機：${err.message}`;
                console.error("selectBackCamera() 錯誤:", err);
            }
        }

        async function startScanner() {
            console.log("startScanner() 被呼叫");
            if (!isSecureContext) {
                errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面";
                return;
            }
            if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                errorEl.textContent = "❌ 掃描器已在運行";
                return;
            }

            if (!selectedCameraId) {
                errorEl.textContent = "❌ 正在載入相機配置...";
                await selectBackCamera();
                if (!selectedCameraId) {
                    errorEl.textContent = "❌ 無法選擇相機，請檢查設備";
                    return;
                }
            }

            resultEl.textContent = "";
            errorEl.textContent = "";
            retryButton.style.display = "none";
            document.getElementById("reader").classList.add("loading");

            if (typeof Html5Qrcode === 'undefined') {
                errorEl.textContent = "❌ Html5Qrcode 物件未定義";
                console.error("Html5Qrcode is not defined");
                return;
            }
            html5QrCode = new Html5Qrcode("reader");

            try {
                console.log("嘗試啟動掃描器，相機 ID:", selectedCameraId);
                await html5QrCode.start(
                    { deviceId: { exact: selectedCameraId } },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    async decodedText => {
                        console.log("掃描成功，內容:", decodedText);
                        document.getElementById("item").value = decodedText;
                        resultEl.textContent = `✅ 掃描成功！`;

                        try {
                            // 將此處的 URL 替換為你的 Google Apps Script Web 應用程式 URL
                            const locationData = await getLocation(decodedText);
                            document.getElementById("location").value = locationData;
                        } catch (error) {
                            errorEl.textContent = `❌ 查詢地點失敗：${error.message}`;
                            console.error("查詢地點錯誤:", error);
                            document.getElementById("location").value = "查詢錯誤";
                        }
                        stopScanner();
                    },
                    errorMessage => {
                        console.log("掃描錯誤:", errorMessage);
                    }
                );
                document.getElementById("reader").classList.remove("loading");
                stopButton.style.display = "inline-block";
                console.log("掃描器已啟動");
            } catch (err) {
                document.getElementById("reader").classList.remove("loading");
                errorEl.textContent = `❌ 啟動相機失敗：${err.message}`;
                retryButton.style.display = "inline-block";
                console.error("啟動掃描器錯誤:", err);
            }
        }

        function stopScanner() {
            console.log("stopScanner() 被呼叫");
            if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                html5QrCode
                    .stop()
                    .then(() => {
                        document.getElementById("reader").innerHTML = "";
                        stopButton.style.display = "none";
                        errorEl.textContent = "";
                        console.log("掃描器已停止");
                    })
                    .catch(err => {
                        errorEl.textContent = `❌ 停止掃描失敗：${err.message}`;
                        console.error("停止掃描錯誤:", err);
                    });
            }
        }

        async function getLocation(itemCode) {
            // 將此處的 URL 替換為你的 Google Apps Script Web 應用程式 URL
            const scriptUrl = `https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec?action=getLocation&itemCode=${encodeURIComponent(itemCode)}`;
            try {
                const response = await fetch(scriptUrl);
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data.location;
            } catch (err) {
                throw new Error(`查詢地點失敗：${err.message}`);
            }
        }

        function submitForm() {
            const staff = document.getElementById("staff").value.trim();
            const item = document.getElementById("item").value.trim();
            const location = document.getElementById("location").value.trim();
            const to = document.getElementById("to").value.trim();
            const note = document.getElementById("note").value.trim();

            if (!staff || !item) {
                errorEl.textContent = "❌ 請選擇員工並輸入品項";
                return;
            }

            const params = new URLSearchParams({
                action: "submitForm",
                staff,
                item,
                location,
                to,
                note
            });

            // 將此處的 URL 替換為你的 Google Apps Script Web 應用程式 URL
            fetch("https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: params.toString()
            })
                .then(res => res.json())
                .then(data => {
                    if (data.result === "success") {
                        resultEl.textContent = "✅ 資料已成功寫入！";
                        errorEl.textContent = "";
                        document.getElementById("item").value = "";
                        staffSelect.value = "";
                    } else {
                        errorEl.textContent = "❌ 寫入失敗：" + data.message;
                    }
                })
                .catch(err => {
                    errorEl.textContent = "❌ 傳送錯誤：" + err.message;
                });
        }

        window.onload = async () => {
            console.log("window.onload 被呼叫");
            if (!isSecureContext) return;
            await Promise.all([
                loadStaffList(),
                selectBackCamera()
            ]);
            if (selectedCameraId) {
                setTimeout(startScanner, 2000);
            }
        };
    </script>
</body>
</html>
