<!DOCTYPE html>
<html>
<head>
    <title>條碼掃描測試</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* 你的 CSS 樣式 */
        body {
            display: flex;
            flex-direction: row; /* 水平排列 */
            justify-content: space-between; /* 左右留白 */
            align-items: flex-start; /* 頂端對齊 */
            padding: 20px;
        }
        #reader {
            width: 45%; /* 調整寬度，讓它佔據一半 */
            max-width: 600px; /* 你之前的最大寬度 */
            margin-right: 20px; /* 與右側表單間的間距 */
        }
        #formContainer {
            width: 50%; /* 讓表單佔據一半 */
            max-width: 400px; /* 表單的最大寬度 */
        }

        .loading {
            background-color: #f0f0f0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select, button {
            margin-bottom: 15px;
            width: 100%; /* 讓表單元素寬度撐滿 */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #error, #success {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        #error {
            background-color: #ffe0e0;
            color: #ff0000;
        }
        #success {
            background-color: #e0fff0;
            color: #008000;
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="reader"></div>
    <div id="formContainer">
        <div id="success" style="color:green; font-weight: bold;"></div>
        <div id="error" style="color:red; font-weight: bold;"></div>
        <label for="staff">員工：</label>
        <select id="staff"></select><br><br>
        <label for="item">財產編號：</label>
        <input type="text" id="item" readonly><br><br>
        <label for="description">描述：</label>
        <input type="text" id="description" readonly><br><br>
        <label for="location">目前位置：</label>
        <input type="text" id="location"><br><br>
        <label for="to">移至：</label>
        <input type="text" id="to"><br><br>
        <label for="note">備註：</label>
        <input type="text" id="note"><br><br>

        <button id="startButton" onclick="startScanner()">開始掃描</button>
        <button id="stopButton" onclick="stopScanner()" style="display:none;">停止掃描</button>
        <button id="retryButton" onclick="startScanner()" style="display:none;">重試</button>
        <button onclick="submitForm()">送出</button>
    </div>

    <script>
        // 你的 JavaScript 程式碼
        let html5QrCode;
        const resultEl = document.getElementById("success");
        const errorEl = document.getElementById("error");
        const stopButton = document.getElementById("stopButton");
        const retryButton = document.getElementById("retryButton");
        const staffSelect = document.getElementById("staff");
        let selectedCameraId;
        let isSecureContext = window.isSecureContext;
        const descriptionInput = document.getElementById("description");
        const locationInput = document.getElementById("location");

        console.log("頁面載入時 - isSecureContext:", isSecureContext);

        // Check for secure context (HTTPS or localhost)
        if (!isSecureContext) {
            errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面以啟用攝影機";
            document.querySelectorAll("button").forEach(btn => btn.disabled = true);
        }

        // Load staff list from Google Sheets using fetch
        async function loadStaffList() {
            console.log("loadStaffList() 被呼叫");
            try {
                // 替換為你的 Google Apps Script Web 應用程式 URL
                const scriptUrl = "https://script.google.com/macros/s/AKfycbwXCCFCfIT49h4JEp_DSxXBg3qlxfcQfK7ewjm552Y22AJR1bzjG_JnXRmQT2jB0W39Kg/exec?action=getStaffList";
                const response = await fetch(scriptUrl);
                const staffList = await response.json();

                // 檢查是否成功獲取到員工清單
                if (!staffList || !Array.isArray(staffList) || staffList.length === 0) {
                    errorEl.textContent = "❌ 無法取得員工清單或清單為空";
                    console.error("loadStaffList() 錯誤: 無效的員工清單", staffList);
                    staffSelect.disabled = true;
                    return;
                }

                staffSelect.innerHTML = '<option value="">請選擇</option>' +
                    staffList.map(name => `<option value="${name}">${name}</option>`).join("");
                console.log("loadStaffList() 成功載入員工清單:", staffList);
            } catch (err) {
                errorEl.textContent = `❌ 無法載入員工清單：${err.message}`;
                console.error("loadStaffList() 錯誤:", err);
                staffSelect.disabled = true;
            }
        }

        async function selectBackCamera() {
            if (!isSecureContext) return;
            console.log("selectBackCamera() 被呼叫");
            try {
                const cameras = await Html5Qrcode.getCameras();
                console.log("可用相機:", cameras);
                if (cameras && cameras.length) {
                    // 嘗試找到後置主鏡頭
                    const rearCamera = cameras.find(camera => {
                        const label = camera.label ? camera.label.toLowerCase() : "";
                        return label.includes("後置") && !label.includes("廣角") && !label.includes("長焦") && !label.includes("telephoto");
                    });
                    // 備用方案：找到包含 "後置" 或 "rear" 的鏡頭
                    const fallbackBackCamera = cameras.find(camera => {
                        const label = camera.label ? camera.label.toLowerCase() : "";
                        return label.includes("後置") || label.includes("rear");
                    });
                    selectedCameraId = rearCamera ? rearCamera.id : (fallbackBackCamera ? fallbackBackCamera.id : cameras[0].id);
                    console.log("選擇的相機 ID:", selectedCameraId);
                } else {
                    errorEl.textContent = "❌ 找不到攝影機，請檢查設備是否有可用相機";
                    console.error("找不到攝影機");
                }
            } catch (err) {
                errorEl.textContent = `❌ 無法取得攝影機：${err.message}`;
                console.error("selectBackCamera() 錯誤:", err);
            }
        }

        async function startScanner() {
            console.log("startScanner() 被呼叫");
            if (!isSecureContext) {
                errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面";
                return;
            }
            if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                errorEl.textContent = "❌ 掃描器已在運行";
                return;
            }

            if (!selectedCameraId) {
                errorEl.textContent = "❌ 正在載入相機配置...";
                await selectBackCamera();
                if (!selectedCameraId) {
                    errorEl.textContent = "❌ 無法選擇相機，請檢查設備";
                    return;
                }
            }

            resultEl.textContent = "";
            errorEl.textContent = "";
            retryButton.style.display = "none";
            document.getElementById("reader").classList.add("loading");

            html5QrCode = new Html5Qrcode("reader");

            try {
                console.log("嘗試啟動掃描器，相機 ID:", selectedCameraId);
                await html5QrCode.start(
                    { deviceId: { exact: selectedCameraId } },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    async (decodedText) => {
                        console.log("掃描成功，內容:", decodedText);
                        document.getElementById("item").value = decodedText;
                        resultEl.textContent = `✅ 掃描成功！`;
                        stopScanner();
                        searchLocation(decodedText); // 掃描成功後查詢
                    },
                    (errorMessage) => {
                        // 略過頻繁的錯誤信息記錄
                        console.log("掃描錯誤:", errorMessage);
                    }
                );
                document.getElementById("reader").classList.remove("loading");
                stopButton.style.display = "inline-block";
                console.log("掃描器已啟動");
            } catch (err) {
                document.getElementById("reader").classList.remove("loading");
                errorEl.textContent = `❌ 啟動相機失敗：${err.message}`;
                retryButton.style.display = "inline-block";
                console.error("啟動掃描器錯誤:", err);
            }
        }

        function stopScanner() {
            console.log("stopScanner() 被呼叫");
            if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
                html5QrCode
                    .stop()
                    .then(() => {
                        document.getElementById("reader").innerHTML = "";
                        stopButton.style.display = "none";
                        errorEl.textContent = "";
                        console.log("掃描器已停止");
                    })
                    .catch(err => {
                        errorEl.textContent = `❌ 停止掃描失敗：${err.message}`;
                        console.error("停止掃描錯誤:", err);
                    });
            }
        }

        async function getLocation(itemCode) {
            const scriptUrl = `https://script.google.com/macros/s/AKfycbwXCCFCfIT49h4JEp_DSxXBg3qlxfcQfK7ewjm552Y22AJR1bzjG_JnXRmQT2jB0W39Kg/exec?action=getLocation&itemCode=${encodeURIComponent(itemCode)}`;
            try {
                const response = await fetch(scriptUrl);
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (err) {
                throw new Error(`查詢地點失敗：${err.message}`);
            }
        }

        async function searchLocation(itemCode) {
            console.log("searchLocation() 被呼叫，查詢的財產編號:", itemCode);
            try {
                const itemData = await getLocation(itemCode);
                console.log("查詢getLocation回傳結果", itemData);
                locationInput.value = itemData.location;
                descriptionInput.value = itemData.description;
            } catch (error) {
                errorEl.textContent = `❌ 查詢地點失敗：${error.message}`;
                console.error("查詢地點錯誤:", error);
            }
        }

        function submitForm() {
            const staff = document.getElementById("staff").value.trim();
            const item = document.getElementById("item").value.trim();
            const location = document.getElementById("location").value.trim();
            const to = document.getElementById("to").value.trim();
            const note = document.getElementById("note").value.trim();

            if (!staff || !item) {
                errorEl.textContent = "❌ 請選擇員工並輸入品項";
                return;
            }

            fetch("https://script.google.com/macros/s/AKfycbwXCCFCfIT49h4JEp_DSxXBg3qlxfcQfK7ewjm552Y22AJR1bzjG_JnXRmQT2jB0W39Kg/exec", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ staff, item, location, to, note })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.result === "success") {
                        resultEl.textContent = "✅ 資料已成功寫入！";
                        errorEl.textContent = "";
                        document.getElementById("item").value = "";
                        staffSelect.value = "";
                    } else {
                        errorEl.textContent = "❌ 寫入失敗：" + data.message;
                    }
                })
                .catch(err => {
                    errorEl.textContent = "❌ 傳送錯誤：" + err;
                });
        }

        // Initialize on page load
        window.onload = async () => {
            console.log("window.onload 被呼叫");
            if (!isSecureContext) return;
            await Promise.all([
                loadStaffList(),
                selectBackCamera()
            ]);
            if (selectedCameraId) {
                setTimeout(startScanner, 1000);
            }
        };
    </script>
</body>
</html>
