<!DOCTYPE html>
<html>
<head>
    <title>æ¢ç¢¼æƒææ¸¬è©¦</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* æ‚¨çš„ CSS æ¨£å¼ */
        #reader {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }

        .loading {
            background-color: #f0f0f0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
    <script>
        let html5QrCode;
        let selectedCameraId;

        function switchCamera() {
            const selected = document.getElementById("cameraSelect").value;
            if (selected && selected !== selectedCameraId) {
                selectedCameraId = selected;
                localStorage.setItem("preferredCameraId", selected);
                stopScanner();
                setTimeout(startScanner, 300); // å»¶é²å¾Œå•Ÿå‹•æƒæå™¨
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById("reader").innerHTML = "";
                    document.getElementById("stopButton").style.display = "none";
                });
            }
        }
    </script>
</head>
<body>
    <div style="max-width:600px;margin:0 auto 20px auto;text-align:center;">
        <label for="cameraSelect" style="font-weight:bold;">ğŸ¥ é¸æ“‡é¡é ­ï¼š</label><br>
        <select id="cameraSelect" onchange="switchCamera()" style="padding:6px;width:90%;max-width:300px;"></select>
    </div>
    <div id="reader"></div>
    <div id="success" style="color:green; font-weight: bold;"></div>
    <div id="error" style="color:red; font-weight: bold;"></div>
    <label for="staff">å“¡å·¥ï¼š</label>
    <select id="staff"></select><br><br>
    <label for="item">è²¡ç”¢ç·¨è™Ÿï¼š</label>
    <input type="text" id="item" readonly><br><br>
    <label for="itemName">å“é …åï¼š</label>
    <input type="text" id="itemName" readonly><br><br>
    <label for="description">æè¿°ï¼š</label>
    <input type="text" id="description" readonly><br><br>
    <label for="location">ç›®å‰ä½ç½®ï¼š</label>
    <input type="text" id="location"><br><br>
    <label for="to">ç§»è‡³ï¼š</label>
    <input type="text" id="to"><br><br>
    <label for="note">å‚™è¨»ï¼š</label>
    <input type="text" id="note"><br><br>

    <button id="startButton" onclick="startScanner()">é–‹å§‹æƒæ</button>
    <button id="stopButton" onclick="stopScanner()" style="display:none;">åœæ­¢æƒæ</button>
    <button id="retryButton" onclick="startScanner()" style="display:none;">é‡è©¦</button>
    <button onclick="submitForm()">é€å‡º</button>

    <script>
        const API_BASE = "https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec";
        let html5QrCode;
        let availableCameras = [];
        let selectedCameraId;

        async function loadStaffList() {
            try {
                const response = await fetch(`${API_BASE}?action=getStaffList`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const staffList = await response.json();
                if (Array.isArray(staffList)) {
                    const staffSelect = document.getElementById("staff");
                    staffSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>' +
                        staffList.map(name => `<option value="${name}">${name}</option>`).join("");
                } else {
                    document.getElementById("error").textContent = "âŒ å“¡å·¥æ¸…å–®è®€å–å¤±æ•—ï¼šä¼ºæœå™¨å›æ‡‰éŒ¯èª¤";
                    console.error("å“¡å·¥æ¸…å–®éŒ¯èª¤ï¼š", staffList);
                }
            } catch (err) {
                document.getElementById("error").textContent = "âŒ å“¡å·¥æ¸…å–®è®€å–éŒ¯èª¤ï¼š" + err.message;
                console.error(err);
            }
        }

        async function getItemData(itemCode) {
            try {
                const response = await fetch(`${API_BASE}?action=getLocation&itemCode=${encodeURIComponent(itemCode)}`);
                 if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("å–å¾—è³‡æ–™ï¼š", data);
                return data;
            } catch(error){
                 document.getElementById("error").textContent = "âŒ å–å¾—ç‰©å“è³‡æ–™éŒ¯èª¤ï¼š" + error.message;
                 console.error(error);
                 return {error: true}; //Return an object with error property
            }
        }

        async function startScanner() {
            const readerEl = document.getElementById("reader");
            document.getElementById("success").textContent = "";
            document.getElementById("error").textContent = "";
            readerEl.classList.add("loading");

            try {
                const devices = await Html5Qrcode.getCameras();
                if (!devices.length) throw new Error("æ‰¾ä¸åˆ°æ”å½±æ©Ÿ");
                availableCameras = devices;
                const cameraSelect = document.getElementById("cameraSelect");
                cameraSelect.innerHTML = devices.map((d, i) => `<option value="${d.id}">${d.label || `é¡é ­ ${i + 1}`}</option>`).join("");

                // å˜—è©¦æ¢å¾©ä¸Šæ¬¡é¸æ“‡çš„ç›¸æ©Ÿ
                const savedCameraId = localStorage.getItem("preferredCameraId");
                selectedCameraId = savedCameraId || devices[0].id;  // å¦‚æœæ²’æœ‰ä¿å­˜ï¼Œå‰‡ä½¿ç”¨ç¬¬ä¸€å€‹
                cameraSelect.value = selectedCameraId; // è¨­å®šä¸‹æ‹‰é¸å–®çš„å€¼

                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    { deviceId: { exact: selectedCameraId } }, // ä½¿ç”¨é¸æ“‡çš„ç›¸æ©Ÿ ID
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    async decodedText => {
                        document.getElementById("item").value = decodedText;
                        const data = await getItemData(decodedText);
                        if (!data.error) { // Check for the error property
                            document.getElementById("itemName").value = data.item || "";
                            document.getElementById("description").value = data.desc || "";
                            document.getElementById("location").value = data.location || "";
                            document.getElementById("success").textContent = "âœ… æƒææˆåŠŸ";
                        } else {
                            document.getElementById("error").textContent = "âŒ æŸ¥ç„¡è³‡æ–™";
                        }
                        stopScanner();
                    }
                );
                document.getElementById("stopButton").style.display = "inline-block";
            } catch (err) {
                document.getElementById("error").textContent = `âŒ å•Ÿå‹•å¤±æ•—ï¼š${err.message}`;
                console.error(err);
            } finally {
                readerEl.classList.remove("loading");
            }
        }



        function submitForm() {
            const staff = document.getElementById("staff").value.trim();
            const item = document.getElementById("item").value.trim();
            const location = document.getElementById("location").value.trim();
            const to = document.getElementById("to").value.trim();
            const note = document.getElementById("note").value.trim();

            if (!staff || !item) {
                document.getElementById("error").textContent = "âŒ è«‹é¸æ“‡å“¡å·¥ä¸¦æƒæè²¡ç”¢ç·¨è™Ÿ";
                return;
            }

            fetch(API_BASE, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    action: "submitForm",
                    staff, item, location, to, note
                })
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                   return res.json()
                })
                .then(data => {
                    if (data.result === "success") {
                        document.getElementById("success").textContent = "âœ… å¯«å…¥æˆåŠŸ";
                        document.getElementById("error").textContent = "";
                    } else {
                        document.getElementById("error").textContent = "âŒ å¯«å…¥å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤");
                    }
                })
                .catch(err => {
                    document.getElementById("error").textContent = "âŒ ç™¼é€å¤±æ•—ï¼š" + err.message;
                });
        }

        window.onload = () => {
            if (window.isSecureContext) {
                loadStaffList();
                Html5Qrcode.getCameras().then(devices => {
                    availableCameras = devices;
                    const cameraSelect = document.getElementById("cameraSelect");
                    cameraSelect.innerHTML = devices.map((d, i) => `<option value="${d.id}">${d.label || `é¡é ­ ${i + 1}`}</option>`).join("");

                    // å˜—è©¦æ¢å¾©ä¸Šæ¬¡é¸æ“‡çš„ç›¸æ©Ÿ
                    const savedCameraId = localStorage.getItem("preferredCameraId");
                    selectedCameraId = savedCameraId || devices[0].id; // å¦‚æœæ²’æœ‰ä¿å­˜ï¼Œå‰‡ä½¿ç”¨ç¬¬ä¸€å€‹
                    cameraSelect.value = selectedCameraId;  // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®

                    setTimeout(startScanner, 500);
                }).catch(err => {
                    document.getElementById("error").textContent = "âŒ ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹å…è¨±ç€è¦½å™¨æ¬Šé™ï¼š" + err.message;
                    console.error("ç„¡æ³•å–å¾—ç›¸æ©Ÿè£ç½®ï¼š", err);
                });
            } else {
                document.getElementById("error").textContent = "âŒ è«‹ä½¿ç”¨ HTTPS é–‹å•Ÿæœ¬é ";
            }
        };
    </script>
</body>
</html>
