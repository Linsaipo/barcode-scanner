<script>
  let html5QrCode;
  const resultEl = document.getElementById("success");
  const errorEl = document.getElementById("error");
  const stopButton = document.getElementById("stopButton");
  const retryButton = document.getElementById("retryButton");
  const staffSelect = document.getElementById("staff");
  let selectedCameraId;
  let isSecureContext = window.isSecureContext;

  console.log("頁面載入時 - isSecureContext:", isSecureContext);

  // Check for secure context (HTTPS or localhost)
  if (!isSecureContext) {
    errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面以啟用攝影機";
    document.querySelectorAll("button").forEach(btn => btn.disabled = true);
  }

  // Load staff list from Google Sheets
  async function loadStaffList() {
    console.log("loadStaffList() 被呼叫");
    try {
      const spreadsheetId = "1j6FUpDvxLSktjQAciiz-IcDeSOUkoi6n8hES196ByC8";
      const sheetGid = "133637117";
      const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetGid}&tqx=out:json`;
      const response = await fetch(url);
      const text = await response.text();
      const json = JSON.parse(text.substring(47, text.length - 2));
      const rows = json.table.rows;
      const staffList = rows.slice(1).map(row => row.c[0]?.v).filter(name => name);
      staffSelect.innerHTML = '<option value="">請選擇</option>' +
        staffList.map(name => `<option value="${name}">${name}</option>`).join("");
      console.log("loadStaffList() 成功載入員工清單:", staffList);
    } catch (err) {
      errorEl.textContent = `❌ 無法載入員工清單：${err.message}`;
      console.error("loadStaffList() 錯誤:", err);
      staffSelect.disabled = true;
    }
  }

  async function selectBackCamera() {
    if (!isSecureContext) return;
    console.log("selectBackCamera() 被呼叫");
    try {
      const cameras = await Html5Qrcode.getCameras();
      console.log("可用相機:", cameras);
      if (cameras && cameras.length) {
        const backCamera = cameras.find(camera => {
          const label = camera.label ? camera.label.toLowerCase() : "";
          return label.includes("後置三鏡頭相機");
        });
        const fallbackBackCamera = cameras.find(camera => {
          const label = camera.label ? camera.label.toLowerCase() : "";
          return label.includes("後置") || label.includes("rear");
        });
        selectedCameraId = backCamera ? backCamera.id : (fallbackBackCamera ? fallbackBackCamera.id : cameras[0].id);
        console.log("選擇的相機 ID:", selectedCameraId);
      } else {
        errorEl.textContent = "❌ 找不到攝影機，請檢查設備是否有可用相機";
        console.error("找不到攝影機");
      }
    } catch (err) {
      errorEl.textContent = `❌ 無法取得攝影機：${err.message}`;
      console.error("selectBackCamera() 錯誤:", err);
    }
  }

  async function startScanner() {
    console.log("startScanner() 被呼叫");
    if (!isSecureContext) {
      errorEl.textContent = "❌ 請使用 HTTPS 或 localhost 訪問此頁面";
      return;
    }
    if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
      errorEl.textContent = "❌ 掃描器已在運行";
      return;
    }

    if (!selectedCameraId) {
      errorEl.textContent = "❌ 正在載入相機配置...";
      await selectBackCamera();
      if (!selectedCameraId) {
        errorEl.textContent = "❌ 無法選擇相機，請檢查設備";
        return;
      }
    }

    resultEl.textContent = "";
    errorEl.textContent = "";
    retryButton.style.display = "none";
    document.getElementById("reader").classList.add("loading");

    html5QrCode = new Html5Qrcode("reader");

    try {
      console.log("嘗試啟動掃描器，相機 ID:", selectedCameraId);
      await html5QrCode.start(
        { deviceId: { exact: selectedCameraId } },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        decodedText => {
          console.log("掃描成功，內容:", decodedText);
          document.getElementById("item").value = decodedText;
          resultEl.textContent = `✅ 掃描成功！`;
          stopScanner();
        },
        errorMessage => {
          // 略過頻繁的錯誤信息記錄
          console.log("掃描錯誤:", errorMessage);
        }
      );
      document.getElementById("reader").classList.remove("loading");
      stopButton.style.display = "inline-block";
      console.log("掃描器已啟動");
    } catch (err) {
      document.getElementById("reader").classList.remove("loading");
      errorEl.textContent = `❌ 啟動相機失敗：${err.message}`;
      retryButton.style.display = "inline-block";
      console.error("啟動掃描器錯誤:", err);
    }
  }

  function stopScanner() {
    console.log("stopScanner() 被呼叫");
    if (html5QrCode && html5QrCode.getState() === Html5QrcodeScannerState.SCANNING) {
      html5QrCode
        .stop()
        .then(() => {
          document.getElementById("reader").innerHTML = "";
          stopButton.style.display = "none";
          errorEl.textContent = "";
          console.log("掃描器已停止");
        })
        .catch(err => {
          errorEl.textContent = `❌ 停止掃描失敗：${err.message}`;
          console.error("停止掃描錯誤:", err);
        });
    }
  }

  function submitForm() {
    const staff = document.getElementById("staff").value.trim();
    const item = document.getElementById("item").value.trim();
    const location = document.getElementById("location").value.trim();
    const to = document.getElementById("to").value.trim();
    const note = document.getElementById("note").value.trim();

    if (!staff || !item) {
      errorEl.textContent = "❌ 請選擇員工並輸入品項";
      return;
    }

    fetch("https://script.google.com/macros/s/AKfycbzK72r-Boa43dJJyKtAHooRjj4pA8qFiG3lJ4t_59uDD0M3nPFDQaqP8u1rTFe91I8alQ/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ staff, item, location, to, note })
    })
      .then(res => res.json())
      .then(data => {
        if (data.result === "success") {
          resultEl.textContent = "✅ 資料已成功寫入！";
          errorEl.textContent = "";
          document.getElementById("item").value = "";
          staffSelect.value = ""; // Reset to "請選擇"
        } else {
          errorEl.textContent = "❌ 寫入失敗：" + data.message;
        }
      })
      .catch(err => {
        errorEl.textContent = "❌ 傳送錯誤：" + err;
      });
  }

  // Initialize on page load
  window.onload = async () => {
    console.log("window.onload 被呼叫");
    if (!isSecureContext) return;
    await Promise.all([
      loadStaffList(),
      selectBackCamera()
    ]);
    if (selectedCameraId) {
      setTimeout(startScanner, 1000); // Delay 1 second for iOS compatibility
    }
  };
</script>
