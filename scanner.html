<!DOCTYPE html>
<html>
<head>
    <title>條碼掃描測試</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        #reader {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
        }
        .loading {
            background-color: #f0f0f0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="reader"></div>
    <div id="success" style="color:green; font-weight: bold;"></div>
    <div id="error" style="color:red; font-weight: bold;"></div>
    <label for="staff">員工：</label>
    <select id="staff"></select><br><br>
    <label for="item">財產編號：</label>
    <input type="text" id="item" readonly><br><br>
    <label for="itemName">品項名：</label>
    <input type="text" id="itemName" readonly><br><br>
    <label for="description">描述：</label>
    <input type="text" id="description" readonly><br><br>
    <label for="location">地點：</label>
    <input type="text" id="location"><br><br>
    <label for="to">移至：</label>
    <input type="text" id="to"><br><br>
    <label for="note">備註：</label>
    <input type="text" id="note"><br><br>

    <button id="startButton" onclick="startScanner()">開始掃描</button>
    <button id="stopButton" onclick="stopScanner()" style="display:none;">停止掃描</button>
    <button id="retryButton" onclick="startScanner()" style="display:none;">重試</button>
    <button onclick="submitForm()">送出</button>

    <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyzJ8aZwDPJ_Ii-p8Rv1HykheqocnnbsqNP6Ebtz2TJvlI8vv_IYF1qBLWRqgY8vs-s/exec";
    let html5QrCode;
    let selectedCameraId;

    async function loadStaffList() {
        try {
            const response = await fetch(`${API_BASE}?action=getStaffList`);
            const staffList = await response.json();
            if (Array.isArray(staffList)) {
                document.getElementById("staff").innerHTML = '<option value="">請選擇</option>' +
                  staffList.map(name => `<option value="${name}">${name}</option>`).join("");
            } else {
                document.getElementById("error").textContent = "❌ 員工清單讀取失敗";
            }
        } catch (err) {
            document.getElementById("error").textContent = "❌ 員工清單讀取錯誤";
            console.error(err);
        }
    }

    async function getItemData(itemCode) {
        const response = await fetch(`${API_BASE}?action=getLocation&itemCode=${encodeURIComponent(itemCode)}`);
        const data = await response.json();
        console.log("取得資料：", data);
        return data;
    }

    async function startScanner() {
        const readerEl = document.getElementById("reader");
        document.getElementById("success").textContent = "";
        document.getElementById("error").textContent = "";
        readerEl.classList.add("loading");

        try {
            const devices = await Html5Qrcode.getCameras();
            if (!devices.length) throw new Error("找不到攝影機");
            selectedCameraId =
                devices.find(d => d.label.toLowerCase().includes("back"))?.id ||
                devices.find(d => d.label.toLowerCase().includes("environment"))?.id ||
                devices[devices.length - 1].id;

            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start(
                { deviceId: { exact: selectedCameraId } },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                async decodedText => {
                    document.getElementById("item").value = decodedText;
                    const data = await getItemData(decodedText);
                    if (!data.error) {
                        document.getElementById("itemName").value = data.item || "";
                        document.getElementById("description").value = data.desc || "";
                        document.getElementById("location").value = data.location || "";
                        document.getElementById("success").textContent = "✅ 掃描成功";
                    } else {
                        document.getElementById("error").textContent = "❌ 查無資料";
                    }
                    stopScanner();
                }
            );
            document.getElementById("stopButton").style.display = "inline-block";
        } catch (err) {
            document.getElementById("error").textContent = `❌ 啟動失敗：${err.message}`;
            console.error(err);
        } finally {
            readerEl.classList.remove("loading");
        }
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById("reader").innerHTML = "";
                document.getElementById("stopButton").style.display = "none";
            });
        }
    }

    function submitForm() {
        const staff = document.getElementById("staff").value.trim();
        const item = document.getElementById("item").value.trim();
        const location = document.getElementById("location").value.trim();
        const to = document.getElementById("to").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!staff || !item) {
            document.getElementById("error").textContent = "❌ 請選擇員工並掃描財產編號";
            return;
        }

        fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                action: "submitForm",
                staff, item, location, to, note
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.result === "success") {
                document.getElementById("success").textContent = "✅ 寫入成功";
                document.getElementById("error").textContent = "";
            } else {
                document.getElementById("error").textContent = "❌ 寫入失敗：" + (data.message || "未知錯誤");
            }
        })
        .catch(err => {
            document.getElementById("error").textContent = "❌ 發送失敗：" + err;
        });
    }

    window.onload = () => {
        if (window.isSecureContext) {
            loadStaffList();
        } else {
            document.getElementById("error").textContent = "❌ 請使用 HTTPS 開啟本頁";
        }
    };
    </script>
</body>
</html>